String url = "https://services.gradle.org/versions/all"

int counter = project.hasProperty("counter") ? Integer.valueOf(project.property("counter")) : 10
task build << {
    (counter).times {
        def start = System.currentTimeMillis()
        try {
            new URL(url).text
            logger.lifecycle "success #$it ${toSeconds(start, System.currentTimeMillis())} seconds"
        } catch (Exception e) {
            logger.lifecycle "failed #$it ${toSeconds(start, System.currentTimeMillis())} seconds"
            traceRoute(new URL(url))
            throw e
        }
    }
}

task trace << {
    traceRoute(new URL(url))
}

void traceRoute(URL location) {
    logger.lifecycle("Starting traceroute")
    def standardOut = new StringBuffer(), standardErr = new StringBuffer()
    String command
    if (org.gradle.internal.os.OperatingSystem.current().windows) {
        command = "tracert ${location.getHost()}"
    } else {
        command = "traceroute ${location.getHost()}"
    }
    def proc = command.execute()
    proc.consumeProcessOutput(standardOut, standardErr)
    proc.waitFor()
    logger.lifecycle "Route trace to ${location.getHost()}"
    logger.lifecycle("""out:
                $standardOut
                err:
                $standardErr""")
}

def toSeconds(start, end) {
    (end - start) / 1000
}
